Vue.component("element-cropimage",Vue.extend({props:{url:{required:!0},value:{default:""},readonly:{type:Boolean,default:!1},name:{type:String,required:!0},options:{type:Array,default:[]}},data:function(){return{errors:[],uploading:!1,val:"",popupCropImage:null,cropImage:null,opts:{cropOptions:{viewMode:1,dragMode:"crop",aspectRatio:16/9,preview:"",responsive:!0,restore:!0,checkCrossOrigin:!0,checkOrientation:!0,modal:!0,guides:!0,center:!0,highlight:!0,background:!0,autoCrop:!0,autoCropArea:.8,movable:!0,rotatable:!0,scalable:!0,zoomable:!0,zoomOnTouch:!0,zoomOnWheel:!0,wheelZoomRatio:.1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!0,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,ready:function(){$(this).cropper("crop")},cropstart:null,cropmove:null,cropend:null,crop:null,zoom:null},getCroppedCanvas:{width:null,height:null,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,fillColor:"transparent",imageSmoothingEnabled:!1,imageSmoothingQuality:"high"}}}},mounted:function(){this.val=this.value,this.opts=_.merge({},this.opts,this.options),this.initUpload()},created:function(){window.addEventListener("keydown",this.keyDownActions)},beforeDestroy:function(){window.removeEventListener("keydown",this.keyDownActions)},methods:{keyDownActions:function(e){var o=this;if((e.ctrlKey||e.metaKey)&&(13==e.keyCode||10==e.keyCode)&&this.popupCropImage&&this.cropImage){var t=$(this.$el.parentNode).find(".upload-button");this.cropImage.cropper("getCroppedCanvas",this.opts.getCroppedCanvas).toBlob(function(e){e.name=o.filename,t[0].dropzone.uploadFiles([e]),o.popupCropImage.close()})}(e.ctrlKey||e.metaKey)&&70==e.keyCode&&(this.opts.cropOptions.aspectRatio=NaN,this.cropImage.cropper("setAspectRatio",NaN))},initUpload:function(){var e=this;$(e.$el.parentNode).find(".upload-button").dropzone({url:this.url,method:"POST",uploadMultiple:!1,previewsContainer:!1,acceptedFiles:"image/*",dictDefaultMessage:"",sending:function(){e.uploading=!0,e.closeAlert()},success:function(o,t){e.val="",e.val=t.value},error:function(o,t){_.isArray(t.errors)&&(e.errors=t.errors)},complete:function(){e.uploading=!1}})},remove:function(){var e=this;Admin.Messages.confirm(trans("lang.message.are_you_sure")).then(function(){e.val=""})},closeAlert:function(){this.errors=[]},crop:function(){var e=this;e.popupCropImage=$.magnificPopup.instance,e.popupCropImage.open({items:{src:e.image},type:"image",callbacks:{imageLoadComplete:function(){var o={"max-width":"90vw","max-height":"90vh"};this.currItem.img.css(o),this.contentContainer.css(o),e.cropImage=this.currItem.img,e.cropImage.cropper(e.opts.cropOptions)},close:function(){e.cropImage.cropper("destroy"),e.cropImage=null,e.popupCropImage=null}}},0)},randomString:function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}},computed:{uploadClass:function(){return this.uploading?"fa fa-spinner fa-spin":"fa fa-upload"},has_value:function(){return this.val.length>0},image:function(){return(0===this.val.indexOf("http")?this.val:Admin.Url.upload(this.val))+"?"+this.randomString()},filename:function(){return this.val.replace(/^.*[\\\/]/,"")}}}));